!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).CWDComments={})}(this,function(t){"use strict";function e(t){const e=t.apiBaseUrl.replace(/\/$/,"");return{fetchComments:async function(r=1,o=20){const n=new URLSearchParams({post_slug:t.postSlug,page:r.toString(),limit:o.toString(),nested:"true"});t.avatarPrefix&&n.set("avatar_prefix",t.avatarPrefix);const i=await fetch(`${e}/api/comments?${n}`);if(!i.ok)throw new Error(`获取评论失败: ${i.status} ${i.statusText}`);return console.log("[API] fetchComments response:",i),i.json()},submitComment:async function(r){const o=await fetch(`${e}/api/comments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({post_slug:t.postSlug,post_title:t.postTitle,post_url:t.postUrl,author:r.author,email:r.email,url:r.url||void 0,content:r.content,parent_id:r.parentId})});if(!o.ok)throw new Error(`提交评论失败: ${o.status} ${o.statusText}`);return o.json()}}}const r="cwd_user_info";class o{constructor(t){this.state={...t},this.listeners=[]}getState(){return{...this.state}}setState(t){const e={...this.state};this.state={...this.state,...t},this.listeners.forEach(t=>{t(this.state,e)})}subscribe(t){return this.listeners.push(t),()=>{this.listeners=this.listeners.filter(e=>e!==t)}}}function n(t,e,n){const i=function(){try{const t=localStorage.getItem(r);if(t){const e=JSON.parse(t);return{author:e.author||"",email:e.email||"",url:e.url||""}}}catch(t){console.error("读取用户信息失败:",t)}return{author:"",email:"",url:""}}(),s=new o({comments:[],loading:!1,error:null,pagination:{page:1,limit:t.pageSize||20,total:0,totalCount:0},form:{author:i.author||"",email:i.email||"",url:i.url||"",content:""},formErrors:{},submitting:!1,replyingTo:null,replyContent:"",replyError:null});async function a(t=1){s.setState({loading:!0,error:null});try{const r=await e(t,s.getState().pagination.limit);console.log("[Store] loadComments response:",r),console.log("[Store] comments data:",r.data),s.setState({comments:r.data,pagination:{page:r.pagination.page,limit:r.pagination.limit,total:r.pagination.total,totalCount:r.pagination.totalCount},loading:!1})}catch(r){s.setState({error:r instanceof Error?r.message:"加载评论失败",loading:!1})}}return s.subscribe(t=>{(t.form.author||t.form.email||t.form.url)&&function(t,e,o){try{const n={author:t,email:e,url:o};localStorage.setItem(r,JSON.stringify(n))}catch(n){console.error("保存用户信息失败:",n)}}(t.form.author,t.form.email,t.form.url)}),{store:s,getTotalPages:()=>s.getState().pagination.total,loadComments:a,submitNewComment:async function(){const t=s.getState(),e=t.form,{validateCommentForm:r}=await Promise.resolve().then(()=>b),o=r(e);if(!o.valid)return s.setState({formErrors:o.errors}),!1;s.setState({formErrors:{},submitting:!0,error:null});try{return await n({author:e.author,email:e.email,url:e.url,content:e.content}),s.setState({form:{...e,content:""},submitting:!1}),await a(t.pagination.page),!0}catch(i){return s.setState({error:i instanceof Error?i.message:"提交评论失败",submitting:!1}),!1}},submitReply:async function(t){const e=s.getState();if(!e.replyContent.trim())return!1;const{validateReplyUserInfo:r}=await Promise.resolve().then(()=>b),o=r(e.form);if(!o.valid){const t=Object.values(o.errors).join("；");return s.setState({replyError:t}),!1}s.setState({formErrors:{},submitting:!0,replyError:null});try{return await n({author:e.form.author,email:e.form.email,url:e.form.url,content:e.replyContent,parentId:t}),s.setState({replyContent:"",replyingTo:null,submitting:!1}),await a(e.pagination.page),!0}catch(i){return s.setState({error:i instanceof Error?i.message:"提交回复失败",submitting:!1}),!1}},startReply:function(t){console.log("[Store] startReply called with commentId:",t),s.setState({replyingTo:t,replyContent:"",replyError:null}),console.log("[Store] New state:",s.getState())},cancelReply:function(){s.setState({replyingTo:null,replyContent:"",replyError:null})},updateFormField:function(t,e){const r={...s.getState().form};r[t]=e,s.setState({form:r})},updateReplyContent:function(t){s.setState({replyContent:t})},clearReplyError:function(){s.setState({replyError:null})},clearError:function(){s.setState({error:null})},goToPage:function(t){const e=s.getState().pagination.total;t>=1&&t<=e&&a(t)}}}class i{constructor(t,e={}){this.container="string"==typeof t?document.querySelector(t):t,this.props=e,this.state={},this.elements={},this.destroyed=!1}setState(t){if(this.destroyed)return;const e={...this.state};this.state="function"==typeof t?{...this.state,...t(e)}:{...this.state,...t},this.update(e)}setProps(t){if(this.destroyed)return;const e={...this.props};this.props={...this.props,...t},this.updateProps(e)}render(){}update(t){this.render()}updateProps(t){}destroy(){this.destroyed=!0,this.container&&this.elements.root&&this.elements.root.parentNode&&this.elements.root.parentNode.removeChild(this.elements.root),this.elements={}}createElement(t,e={}){const r=document.createElement(t);if(e.className&&(r.className=e.className),e.attributes&&Object.entries(e.attributes).forEach(([t,e])=>{if(t.startsWith("on")){const o=t.slice(2).toLowerCase();r.addEventListener(o,e)}else"dataset"===t?Object.entries(e).forEach(([t,e])=>{r.dataset[t]=e}):["disabled","checked","readonly","required","autofocus"].includes(t)?e&&r.setAttribute(t,""):r.setAttribute(t,e)}),void 0!==e.text&&(r.textContent=e.text),void 0!==e.html&&(r.innerHTML=e.html),e.children){(Array.isArray(e.children)?e.children:[e.children]).forEach(t=>{t instanceof HTMLElement&&r.appendChild(t)})}return r}createTextElement(t,e,r=""){return this.createElement(t,{className:r,text:e})}empty(t){for(;t.firstChild;)t.removeChild(t.firstChild)}}class s extends i{constructor(t,e={}){super(t,e),this.state={localForm:{...e.form}}}render(){const{formErrors:t,submitting:e}=this.props,{localForm:r}=this.state,o=r.author.trim()&&r.email.trim()&&r.content.trim(),n=this.createElement("form",{className:"cwd-comment-form",attributes:{novalidate:!0,onSubmit:t=>this.handleSubmit(t)},children:[this.createTextElement("h3","发表评论","cwd-form-title"),this.createElement("div",{className:"cwd-form-fields",children:[this.createElement("div",{className:"cwd-form-row",children:[this.createFormField("昵称 *","text","author",r.author,t.author,"昵称 *"),this.createFormField("邮箱 *","email","email",r.email,t.email,"邮箱 *"),this.createFormField("网址","url","url",r.url,t.url,"网址")]}),this.createElement("div",{className:"cwd-form-field",children:[this.createTextElement("label","评论内容","cwd-form-label"),this.createElement("textarea",{className:"cwd-form-textarea "+(t.content?"cwd-input-error":""),attributes:{placeholder:"写下你的评论...",rows:4,disabled:e,onInput:t=>this.handleFieldChange("content",t.target.value)}}),...t.content?[this.createTextElement("span",t.content,"cwd-error-text")]:[]]})]}),this.createElement("div",{className:"cwd-form-actions",children:[this.createElement("button",{className:"cwd-btn cwd-btn-primary",attributes:{type:"submit",disabled:e||!o},text:e?"提交中...":"提交评论"})]})]});this.setInputValues(n,r),this.elements.root=n,this.empty(this.container),this.container.appendChild(n)}updateProps(t){if(!this.props.submitting&&this.props.form!==t.form){const t=this.state.localForm.author||"",e=this.state.localForm.email||"",r=this.state.localForm.url||"",o=this.state.localForm.content||"";this.state.localForm={author:this.props.form.author||t,email:this.props.form.email||e,url:this.props.form.url||r,content:void 0!==this.props.form.content?this.props.form.content:o},this.elements.root&&this.setInputValues(this.elements.root,this.state.localForm)}this.elements.root&&this.updateFormState()}updateFormState(){const{formErrors:t,submitting:e}=this.props,{localForm:r}=this.state,o=r.author.trim()&&r.email.trim()&&r.content.trim(),n=this.elements.root.querySelector('button[type="submit"]');n&&(n.disabled=e||!o,n.textContent=e?"提交中...":"提交评论");this.elements.root.querySelectorAll("input, textarea").forEach(t=>{t.disabled=e}),this.updateErrors(t)}updateErrors(t){if(!this.elements.root)return;const e=this.elements.root.querySelector('input[placeholder*="昵称"]');this.updateFieldError(e,null==t?void 0:t.author);const r=this.elements.root.querySelector('input[placeholder*="邮箱"]');this.updateFieldError(r,null==t?void 0:t.email);const o=this.elements.root.querySelector('input[placeholder*="网址"]');this.updateFieldError(o,null==t?void 0:t.url);const n=this.elements.root.querySelector("textarea");this.updateFieldError(n,null==t?void 0:t.content)}updateFieldError(t,e){if(!t)return;e?t.classList.add("cwd-input-error"):t.classList.remove("cwd-input-error");const r=t.parentElement;let o=r.querySelector(".cwd-error-text");e?(o||(o=document.createElement("span"),o.className="cwd-error-text",r.appendChild(o)),o.textContent=e):o&&o.remove()}createFormField(t,e,r,o,n,i=""){return this.createElement("div",{className:"cwd-form-field",children:[this.createTextElement("label",t,"cwd-form-label"),this.createElement("input",{className:"cwd-form-input "+(n?"cwd-input-error":""),attributes:{type:e,placeholder:i,disabled:this.props.submitting,onInput:t=>this.handleFieldChange(r,t.target.value)}}),...n?[this.createTextElement("span",n,"cwd-error-text")]:[]]})}setInputValues(t,e){const r=t.querySelector('input[placeholder*="昵称"]'),o=t.querySelector('input[placeholder*="邮箱"]'),n=t.querySelector('input[placeholder*="网址"]'),i=t.querySelector("textarea");r&&(r.value=e.author||""),o&&(o.value=e.email||""),n&&(n.value=e.url||""),i&&(i.value=e.content||"")}handleFieldChange(t,e){this.state.localForm[t]=e,this.props.onFieldChange&&this.props.onFieldChange(t,e),this.elements.root&&this.updateFormState()}handleSubmit(t){t.preventDefault(),this.props.onSubmit&&this.props.onSubmit(this.state.localForm)}}class a extends i{constructor(t,e={}){super(t,e),this.state={content:e.content||""}}render(){const t=this.createElement("div",{className:"cwd-reply-editor",children:[this.createElement("div",{className:"cwd-reply-header",children:[this.createTextElement("span",`回复 @${this.props.replyToAuthor}`,"cwd-reply-to"),this.createElement("button",{className:"cwd-btn-close",attributes:{type:"button",onClick:()=>this.handleCancel()},text:"✕"})]}),this.createElement("textarea",{className:"cwd-reply-textarea",attributes:{rows:3,placeholder:"写下你的回复...",disabled:this.props.submitting,onInput:t=>this.handleInput(t)}}),...this.props.error?[this.createElement("div",{className:"cwd-error-inline cwd-error-small",children:[this.createTextElement("span",this.props.error),this.createElement("button",{className:"cwd-error-close",attributes:{type:"button",onClick:()=>this.handleClearError()},text:"✕"})]})]:[],this.createElement("div",{className:"cwd-reply-actions",children:[this.createElement("button",{className:"cwd-btn cwd-btn-primary cwd-btn-small",attributes:{type:"button",disabled:this.props.submitting||!this.state.content.trim(),onClick:()=>this.handleSubmit()},text:this.props.submitting?"提交中...":"提交回复"}),this.createElement("button",{className:"cwd-btn cwd-btn-secondary cwd-btn-small",attributes:{type:"button",disabled:this.props.submitting,onClick:()=>this.handleCancel()},text:"取消"})]})]}),e=t.querySelector("textarea");e&&(e.value=this.state.content),this.elements.root=t,this.empty(this.container),this.container.appendChild(t)}updateProps(t){if(this.props.content!==this.state.content&&this.props.content!==(null==t?void 0:t.content))return this.state.content=this.props.content,void this.render();this.props.error===(null==t?void 0:t.error)&&this.props.submitting===(null==t?void 0:t.submitting)||this.render()}handleInput(t){var e;this.state.content=t.target.value;const r=null==(e=this.elements.root)?void 0:e.querySelector(".cwd-btn-primary");r&&(r.disabled=this.props.submitting||!this.state.content.trim()),this.props.onUpdate&&this.props.onUpdate(this.state.content)}handleSubmit(){this.props.onSubmit&&this.props.onSubmit()}handleCancel(){this.props.onCancel&&this.props.onCancel()}handleClearError(){this.props.onClearError&&this.props.onClearError()}setContent(t){var e;this.state.content=t;const r=null==(e=this.elements.root)?void 0:e.querySelector("textarea");r&&(r.value=t)}getContent(){return this.state.content}focus(){var t;const e=null==(t=this.elements.root)?void 0:t.querySelector("textarea");e&&e.focus()}}function l(t){const e=new Date(t),r=(new Date).getTime()-e.getTime(),o=Math.floor(r/1e3),n=Math.floor(o/60),i=Math.floor(n/60),s=Math.floor(i/24);return s<3?s>0?1===s?"昨天":`${s}天前`:i>0?`${i}小时前`:n>0?`${n}分钟前`:"刚刚":function(t){const e=new Date(t),r=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),i=String(e.getHours()).padStart(2,"0"),s=String(e.getMinutes()).padStart(2,"0"),a=String(e.getSeconds()).padStart(2,"0");return`${r}/${o}/${n} ${i}:${s}:${a}`}(t)}class c extends i{constructor(t,e={}){super(t,e),this.replyEditor=null,this.childCommentItems=[]}render(){const{comment:t,isReply:e,adminEmail:r,adminBadge:o}=this.props,n=this.props.replyingTo===t.id,i=r&&t.email===r,s=this.createElement("div",{className:"cwd-comment-item "+(e?"cwd-comment-reply":""),children:[this.createElement("div",{className:"cwd-comment-avatar",children:[this.createElement("img",{attributes:{src:t.avatar,alt:t.author,loading:"lazy"}})]}),this.createElement("div",{className:"cwd-comment-body",children:[this.createElement("div",{className:"cwd-comment-header",children:[this.createElement("div",{className:"cwd-comment-author",children:[t.url?this.createElement("span",{className:"cwd-author-name",children:[this.createElement("a",{attributes:{href:t.url,target:"_blank",rel:"noopener noreferrer"},text:t.author})]}):this.createTextElement("span",t.author,"cwd-author-name"),...i?[this.createTextElement("span",`${o}`,"cwd-admin-badge")]:[],...t.replyToAuthor?[this.createTextElement("span"," 回复 ","cwd-reply-to-separator"),this.createTextElement("span",t.replyToAuthor,"cwd-reply-to-author")]:[]]}),this.createElement("div",{className:"cwd-comment-actions",children:[this.createElement("span",{className:"cwd-action-btn",attributes:{onClick:()=>this.handleReply()},text:"回复"}),this.createTextElement("span",l(t.pubDate),"cwd-comment-time")]})]}),this.createElement("div",{className:"cwd-comment-content"}),this.createElement("div",{className:"cwd-reply-editor-container"}),...t.replies&&t.replies.length>0?[this.createElement("div",{className:"cwd-replies"})]:[]]})]}),d=s.querySelector(".cwd-comment-content");if(d&&(d.innerHTML=t.contentHtml),n){const e=s.querySelector(".cwd-reply-editor-container");e&&(this.replyEditor=new a(e,{replyToAuthor:t.author,content:this.props.replyContent,error:this.props.replyError,submitting:this.props.submitting,onUpdate:t=>this.handleUpdateReplyContent(t),onSubmit:()=>this.handleSubmitReply(),onCancel:()=>this.handleCancelReply(),onClearError:()=>this.handleClearReplyError()}),this.replyEditor.render(),this.replyEditor.focus())}else this.replyEditor=null;if(this.childCommentItems=[],t.replies&&t.replies.length>0){const e=s.querySelector(".cwd-replies");e&&t.replies.forEach(t=>{const r=new c(e,{comment:t,isReply:!0,replyingTo:this.props.replyingTo,replyContent:this.props.replyContent,replyError:this.props.replyError,submitting:this.props.submitting,adminEmail:this.props.adminEmail,adminBadge:this.props.adminBadge,onReply:this.props.onReply,onSubmitReply:this.props.onSubmitReply,onCancelReply:this.props.onCancelReply,onUpdateReplyContent:this.props.onUpdateReplyContent,onClearReplyError:this.props.onClearReplyError});r.render(),this.childCommentItems.push(r)})}this.elements.root=s,this.container.contains(s)?this.container.replaceChild(s,this.elements.root):this.container.appendChild(s)}updateProps(t){var e;const{comment:r}=this.props,o=t.replyingTo===r.id,n=this.props.replyingTo===r.id;if(this.props.comment===t.comment){if(n!==o){const t=null==(e=this.elements.root)?void 0:e.querySelector(":scope > .cwd-comment-body > .cwd-reply-editor-container");n&&t?(this.replyEditor=new a(t,{replyToAuthor:r.author,content:this.props.replyContent,error:this.props.replyError,submitting:this.props.submitting,onUpdate:t=>this.handleUpdateReplyContent(t),onSubmit:()=>this.handleSubmitReply(),onCancel:()=>this.handleCancelReply(),onClearError:()=>this.handleClearReplyError()}),this.replyEditor.render(),this.replyEditor.focus()):!n&&t&&(t.innerHTML="",this.replyEditor=null)}else n&&this.replyEditor&&this.replyEditor.setProps({content:this.props.replyContent,error:this.props.replyError,submitting:this.props.submitting});this.childCommentItems&&this.childCommentItems.length>0&&this.childCommentItems.forEach(t=>{t.setProps({replyingTo:this.props.replyingTo,replyContent:this.props.replyContent,replyError:this.props.replyError,submitting:this.props.submitting})})}else this.render()}handleReply(){console.log("[CommentItem] handleReply called, comment.id:",this.props.comment.id),this.props.onReply?this.props.onReply(this.props.comment.id):console.warn("[CommentItem] onReply callback is missing!")}handleSubmitReply(){this.props.onSubmitReply&&this.props.onSubmitReply(this.props.comment.id)}handleCancelReply(){this.props.onCancelReply&&this.props.onCancelReply()}handleUpdateReplyContent(t){this.props.onUpdateReplyContent&&this.props.onUpdateReplyContent(t)}handleClearReplyError(){this.props.onClearReplyError&&this.props.onClearReplyError()}}class d extends i{constructor(t,e={}){super(t,{text:"加载中...",...e})}render(){const t=this.createElement("div",{className:"cwd-loading",children:[this.createElement("div",{className:"cwd-spinner"}),this.createTextElement("span",this.props.text,"cwd-loading-text")]});this.elements.root=t,this.empty(this.container),this.container.appendChild(t)}setText(t){this.props.text=t;const e=this.elements.root.querySelector(".cwd-loading-text");e&&(e.textContent=t)}}class p extends i{constructor(t,e={}){super(t,e),this.state={currentPage:e.currentPage||1,totalPages:e.totalPages||1}}getDisplayedPages(){const{currentPage:t,totalPages:e}=this.state,r=[],o=Math.max(1,t-Math.floor(2.5)),n=Math.min(e,o+5-1);for(let i=n-5+1;i<=n;i++)i>=1&&r.push(i);return r.slice(0,5)}render(){if(this.state.totalPages<=1)return void this.empty(this.container);const t=this.getDisplayedPages(),e=this.createElement("div",{className:"cwd-pagination",children:[this.createElement("button",{className:"cwd-page-btn",attributes:{type:"button",disabled:1===this.state.currentPage,onClick:()=>this.handlePrev()},text:"上一页"}),this.createElement("div",{className:"cwd-page-numbers",children:t.map(t=>this.createElement("button",{className:"cwd-page-num "+(t===this.state.currentPage?"cwd-page-num-active":""),attributes:{type:"button",onClick:()=>this.handleGoTo(t)},text:t.toString()}))}),this.createElement("button",{className:"cwd-page-btn",attributes:{type:"button",disabled:this.state.currentPage===this.state.totalPages,onClick:()=>this.handleNext()},text:"下一页"})]});this.elements.root=e,this.empty(this.container),this.container.appendChild(e)}updateProps(){this.state.currentPage=this.props.currentPage,this.state.totalPages=this.props.totalPages,this.render()}handlePrev(){this.props.onPrev&&this.props.onPrev()}handleNext(){this.props.onNext&&this.props.onNext()}handleGoTo(t){this.props.onGoTo&&this.props.onGoTo(t)}}class m extends i{constructor(t,e={}){super(t,e),this.loadingComponent=null,this.paginationComponent=null,this.commentItems=new Map}render(){const{comments:t,loading:e,error:r,currentPage:o,totalPages:n}=this.props;if(console.log("[CommentList] render called, comments:",t),console.log("[CommentList] comments.length:",null==t?void 0:t.length),console.log("[CommentList] loading:",e),this.empty(this.container),e&&0===t.length)return this.loadingComponent=new d(this.container,{text:"加载评论中..."}),this.loadingComponent.render(),void(this.elements.root=this.loadingComponent.elements.root);if(r&&0===t.length){const t=this.createElement("div",{className:"cwd-error",children:[this.createTextElement("span",r),this.createElement("button",{className:"cwd-error-retry",attributes:{type:"button",onClick:()=>this.handleRetry()},text:"重试"})]});return this.elements.root=t,void this.container.appendChild(t)}const i=this.createElement("div",{className:"cwd-comment-list"});if(t.length>0){const e=this.createElement("div",{className:"cwd-comments"});this.commentItems.clear(),t.forEach((t,r)=>{console.log(`[CommentList] Rendering comment ${r}:`,t);const o=new c(e,{comment:t,replyingTo:this.props.replyingTo,replyContent:this.props.replyContent,replyError:this.props.replyError,submitting:this.props.submitting,adminEmail:this.props.adminEmail,adminBadge:this.props.adminBadge,onReply:t=>this.handleReply(t),onSubmitReply:t=>this.handleSubmitReply(t),onCancelReply:()=>this.handleCancelReply(),onUpdateReplyContent:t=>this.handleUpdateReplyContent(t),onClearReplyError:()=>this.handleClearReplyError()});o.render(),this.commentItems.set(t.id,o)}),console.log("[CommentList] Final commentsContainer children count:",e.children.length),console.log("[CommentList] Final commentsContainer innerHTML:",e.innerHTML),i.appendChild(e)}else{const t=this.createElement("div",{className:"cwd-empty",children:[this.createTextElement("p","暂无评论，快来抢沙发吧！","cwd-empty-text")]});i.appendChild(t)}if(n>1){const t=this.createElement("div");i.appendChild(t),this.paginationComponent=new p(t,{currentPage:o,totalPages:n,onPrev:()=>this.handlePrevPage(),onNext:()=>this.handleNextPage(),onGoTo:t=>this.handleGoToPage(t)}),this.paginationComponent.render()}else this.paginationComponent=null;this.elements.root=i,this.container.appendChild(i)}updateProps(t){if(this.props.loading===t.loading||this.props.loading)if(this.props.comments===t.comments)if(this.props.replyingTo===t.replyingTo&&this.props.replyError===t.replyError&&this.props.submitting===t.submitting){if(this.paginationComponent){(this.props.currentPage!==t.currentPage||this.props.totalPages!==t.totalPages)&&(this.paginationComponent.props.currentPage=this.props.currentPage,this.paginationComponent.props.totalPages=this.props.totalPages,this.paginationComponent.updateProps())}}else this.commentItems.forEach(t=>{t.setProps({replyingTo:this.props.replyingTo,replyContent:this.props.replyContent,replyError:this.props.replyError,submitting:this.props.submitting})});else this.render();else this.render()}handleRetry(){this.props.onRetry&&this.props.onRetry()}handleReply(t){this.props.onReply&&this.props.onReply(t)}handleSubmitReply(t){this.props.onSubmitReply&&this.props.onSubmitReply(t)}handleCancelReply(){this.props.onCancelReply&&this.props.onCancelReply()}handleUpdateReplyContent(t){this.props.onUpdateReplyContent&&this.props.onUpdateReplyContent(t)}handleClearReplyError(){this.props.onClearReplyError&&this.props.onClearReplyError()}handlePrevPage(){this.props.onPrevPage&&this.props.onPrevPage()}handleNextPage(){this.props.onNextPage&&this.props.onNextPage()}handleGoToPage(t){this.props.onGoToPage&&this.props.onGoToPage(t)}}class h{constructor(t){this.config={...t},this.hostElement=this._resolveElement(t.el),this.shadowRoot=null,this.mountPoint=null,this.commentForm=null,this.commentList=null,this.store=null,this.unsubscribe=null,this._mounted=!1}_resolveElement(t){if("string"==typeof t){const e=document.querySelector(t);if(!e)throw new Error(`元素未找到: ${t}`);if(!(e instanceof HTMLElement))throw new Error(`目标不是 HTMLElement: ${t}`);return e}return t}mount(){if(this._mounted)return;this.shadowRoot=this.hostElement.attachShadow({mode:"open"});const t=document.createElement("style");t.textContent=':root,[data-theme=light]{--cwd-primary: #0969da;--cwd-primary-hover: #0864ca;--cwd-text: #24292f;--cwd-text-secondary: #6e7781;--cwd-bg: #ffffff;--cwd-bg-input: #ffffff;--cwd-bg-secondary: #f6f8fa;--cwd-bg-reply: #f6f8fa;--cwd-bg-hover: #f6f8fa;--cwd-bg-disabled: #f6f8fa;--cwd-bg-avatar: #f6f8fa;--cwd-border: #d0d7de;--cwd-border-light: #eaeef2;--cwd-error: #cf222e;--cwd-bg-error: #ffebe9;--cwd-border-error: #fd8c73;--cwd-radius: 6px}[data-theme=dark]{--cwd-primary: #58a6ff;--cwd-primary-hover: #4094ff;--cwd-text: #c9d1d9;--cwd-text-secondary: #8b949e;--cwd-bg: #0d1117;--cwd-bg-input: #0d1117;--cwd-bg-secondary: #161b22;--cwd-bg-reply: #161b22;--cwd-bg-hover: #161b22;--cwd-bg-disabled: #161b22;--cwd-bg-avatar: #161b22;--cwd-border: #30363d;--cwd-border-light: #21262d;--cwd-error: #f85149;--cwd-bg-error: #3d1614;--cwd-border-error: #f85149}*{box-sizing:border-box;margin:0;padding:0}.cwd-comments-container{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Noto Sans,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";font-size:14px;line-height:1.5;color:var(--cwd-text);background:var(--cwd-bg);word-wrap:break-word}.cwd-comments-header{display:flex;align-items:center;justify-content:space-between;padding:16px 0;margin-bottom:16px;border-bottom:1px solid var(--cwd-border)}.cwd-comments-count{font-size:16px;font-weight:600;color:var(--cwd-text)}.cwd-loading{display:flex;align-items:center;justify-content:center;gap:12px;padding:40px 20px;color:var(--cwd-text-secondary, #6e7781)}.cwd-spinner{width:20px;height:20px;border:2px solid var(--cwd-border, #d0d7de);border-top-color:var(--cwd-primary, #0969da);border-radius:50%;animation:cwd-spin .6s linear infinite}@keyframes cwd-spin{to{transform:rotate(360deg)}}.cwd-loading-text{font-size:14px}.cwd-comment-form{background:var(--cwd-bg, #ffffff);border:1px solid var(--cwd-border, #d0d7de);border-radius:var(--cwd-radius, 6px);padding:20px;margin-bottom:24px}.cwd-form-title{margin:0 0 16px;font-size:16px;font-weight:600;color:var(--cwd-text, #24292f)}.cwd-form-fields{display:flex;flex-direction:column;gap:12px}.cwd-form-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}@media(max-width:640px){.cwd-form-row{grid-template-columns:1fr}}.cwd-form-field{display:flex;flex-direction:column;gap:4px}.cwd-form-label{font-size:13px;font-weight:500;color:var(--cwd-text, #24292f)}.cwd-form-field input,.cwd-form-field textarea{width:100%;padding:8px 12px;font-size:14px;line-height:1.5;color:var(--cwd-text, #24292f);background:var(--cwd-bg-input, #ffffff);border:1px solid var(--cwd-border, #d0d7de);border-radius:var(--cwd-radius, 6px);transition:border-color .2s,box-shadow .2s;font-family:inherit}.cwd-form-field input:focus,.cwd-form-field textarea:focus{outline:none;border-color:var(--cwd-primary, #0969da);box-shadow:0 0 0 3px #0969da1a}.cwd-form-field input:disabled,.cwd-form-field textarea:disabled{background:var(--cwd-bg-disabled, #f6f8fa);cursor:not-allowed}.cwd-form-field input.cwd-input-error,.cwd-form-field textarea.cwd-input-error{border-color:var(--cwd-error, #cf222e)}.cwd-form-field textarea{resize:vertical;min-height:80px}.cwd-error-text{font-size:12px;color:var(--cwd-error, #cf222e)}.cwd-form-actions{display:flex;justify-content:flex-end;margin-top:16px}.cwd-btn{padding:8px 16px;font-size:14px;font-weight:500;line-height:1.5;border:none;border-radius:var(--cwd-radius, 6px);cursor:pointer;transition:background-color .2s;font-family:inherit}.cwd-btn-primary{color:#fff;background:var(--cwd-primary, #0969da)}.cwd-btn-primary:hover:not(:disabled){background:var(--cwd-primary-hover, #0864ca)}.cwd-btn:disabled{opacity:.6;cursor:not-allowed}.cwd-reply-editor{margin-top:12px;padding:12px;background:var(--cwd-bg-reply, #f6f8fa);border:1px solid var(--cwd-border, #d0d7de);border-radius:var(--cwd-radius, 6px)}.cwd-reply-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.cwd-reply-to{font-size:13px;font-weight:500;color:var(--cwd-text-secondary, #6e7781)}.cwd-btn-close{width:20px;height:20px;padding:0;font-size:14px;color:var(--cwd-text-secondary, #6e7781);background:transparent;border:none;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color .2s}.cwd-btn-close:hover{background:var(--cwd-bg-hover, rgba(0, 0, 0, .05))}.cwd-reply-textarea{width:100%;padding:8px 12px;font-size:14px;line-height:1.5;color:var(--cwd-text, #24292f);background:var(--cwd-bg-input, #ffffff);border:1px solid var(--cwd-border, #d0d7de);border-radius:var(--cwd-radius, 6px);resize:vertical;font-family:inherit;margin-bottom:8px}.cwd-reply-textarea:focus{outline:none;border-color:var(--cwd-primary, #0969da);box-shadow:0 0 0 3px #0969da1a}.cwd-reply-actions{display:flex;gap:8px;justify-content:flex-end}.cwd-btn-small{padding:4px 10px;font-size:12px}.cwd-btn-secondary{color:var(--cwd-text, #24292f);background:var(--cwd-bg-secondary, #f6f8fa);border:1px solid var(--cwd-border, #d0d7de)}.cwd-btn-secondary:hover:not(:disabled){background:var(--cwd-bg-hover, #eaeef2)}.cwd-comment-item{display:flex;gap:12px;padding:20px 0;border-bottom:1px solid var(--cwd-border-light, #eaeef2)}.cwd-comment-body:hover .cwd-action-btn{display:inline-flex!important}.cwd-comment-item:last-child{border-bottom:none}.cwd-comment-reply{padding-top:12px;padding-bottom:12px}.cwd-comment-avatar{flex-shrink:0;width:40px;height:40px;border-radius:5px;border:1px solid var(--cwd-border, #d0d7de);overflow:hidden;background:var(--cwd-bg-avatar, #f6f8fa)}.cwd-comment-avatar img{width:100%;height:100%;object-fit:cover}.cwd-comment-reply .cwd-comment-avatar{width:32px;height:32px}.cwd-comment-body{flex:1;min-width:0}.cwd-comment-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:4px}.cwd-author-name{font-size:16px;font-weight:600;color:var(--cwd-text, #24292f)}.cwd-author-name a{color:inherit;text-decoration:none}.cwd-author-name a:hover{color:var(--cwd-primary, #0969da);text-decoration:underline}.cwd-comment-author{display:inline-flex;align-items:center}.cwd-admin-badge{background:#db850d;color:#fff;border-radius:3px;padding:1px 4px;font-size:12px;margin:0 4px}.cwd-reply-to-separator{margin:0 4px}.cwd-reply-to-author{font-style:italic}.cwd-comment-time{font-size:12px;color:var(--cwd-text-secondary, #6e7781)}.cwd-comment-content{font-size:14px;line-height:1.6;color:var(--cwd-text, #24292f);word-wrap:break-word;margin-top:10px}.cwd-comment-content p{margin:0 0 8px}.cwd-comment-content p:last-child{margin-bottom:0}.cwd-comment-content a{color:var(--cwd-primary, #0969da);text-decoration:none}.cwd-comment-content a:hover{text-decoration:underline}.cwd-comment-actions{display:flex;align-items:center;gap:12px}.cwd-action-btn{display:inline-flex;align-items:center;font-size:12px;color:var(--cwd-text-secondary, #6e7781);background:transparent;border:none;border-radius:4px;cursor:pointer;transition:background-color .2s;font-family:inherit;display:none}.cwd-action-btn:hover{color:var(--cwd-primary, #0969da)}.cwd-replies{margin-top:12px;padding-left:12px;border-left:2px solid var(--cwd-border-light, #eaeef2)}.cwd-comment-list{min-height:100px}.cwd-comments{display:flex;flex-direction:column}.cwd-error{padding:20px;text-align:center;color:var(--cwd-error, #cf222e);background:var(--cwd-bg-error, #ffebe9);border:1px solid var(--cwd-border-error, #fd8c73);border-radius:var(--cwd-radius, 6px)}.cwd-error-retry{margin-left:12px;padding:4px 12px;font-size:13px;color:#fff;background:var(--cwd-primary, #0969da);border:none;border-radius:4px;cursor:pointer;font-family:inherit}.cwd-error-retry:hover{background:var(--cwd-primary-hover, #0864ca)}.cwd-empty{padding:40px 20px;text-align:center}.cwd-empty-icon{font-size:48px;margin-bottom:12px}.cwd-empty-text{margin:0;font-size:14px;color:var(--cwd-text-secondary, #6e7781)}.cwd-pagination{display:flex;align-items:center;justify-content:center;gap:8px;padding:20px 0}.cwd-page-btn{padding:6px 12px;font-size:13px;color:var(--cwd-text, #24292f);background:var(--cwd-bg, #ffffff);border:1px solid var(--cwd-border, #d0d7de);border-radius:var(--cwd-radius, 6px);cursor:pointer;transition:background-color .2s;font-family:inherit}.cwd-page-btn:hover:not(:disabled){background:var(--cwd-bg-hover, #f6f8fa)}.cwd-page-btn:disabled{opacity:.5;cursor:not-allowed}.cwd-page-numbers{display:flex;gap:4px}.cwd-page-num{min-width:32px;padding:6px 8px;font-size:13px;color:var(--cwd-text, #24292f);background:var(--cwd-bg, #ffffff);border:1px solid var(--cwd-border, #d0d7de);border-radius:var(--cwd-radius, 6px);cursor:pointer;transition:background-color .2s;font-family:inherit}.cwd-page-num:hover{background:var(--cwd-bg-hover, #f6f8fa)}.cwd-page-num-active{color:#fff;background:var(--cwd-primary, #0969da);border-color:var(--cwd-primary, #0969da)}.cwd-error-inline{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;margin-bottom:16px;font-size:14px;color:var(--cwd-error, #cf222e);background:var(--cwd-bg-error, #ffebe9);border:1px solid var(--cwd-border-error, #fd8c73);border-radius:var(--cwd-radius, 6px)}.cwd-error-close{width:20px;height:20px;padding:0;font-size:14px;color:inherit;background:transparent;border:none;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color .2s}.cwd-error-close:hover{background:#0000001a}.cwd-load-more{display:block;width:100%;padding:12px;margin:16px 0;font-size:14px;color:var(--cwd-primary);background:var(--cwd-bg-secondary);border:1px solid var(--cwd-border);border-radius:var(--cwd-radius);cursor:pointer;transition:background-color .2s;font-family:inherit}.cwd-load-more:hover{background:var(--cwd-bg-hover)}.fade-enter-active,.fade-leave-active{transition:opacity .2s ease}.fade-enter-from,.fade-leave-to{opacity:0}.cwd-comments-container::-webkit-scrollbar{width:8px;height:8px}.cwd-comments-container::-webkit-scrollbar-track{background:transparent}.cwd-comments-container::-webkit-scrollbar-thumb{background:var(--cwd-border);border-radius:4px}.cwd-comments-container::-webkit-scrollbar-thumb:hover{background:var(--cwd-text-secondary)}',this.shadowRoot.appendChild(t),this.mountPoint=document.createElement("div"),this.mountPoint.className="cwd-comments-container",this.shadowRoot.appendChild(this.mountPoint),this.config.theme&&this.mountPoint.setAttribute("data-theme",this.config.theme);const r=e(this.config);this.store=n(this.config,r.fetchComments.bind(r),r.submitComment.bind(r)),this.unsubscribe=this.store.store.subscribe(t=>{this._onStateChange(t)}),this._render(),this.store.loadComments(),this._mounted=!0}unmount(){if(this._mounted){if(this.commentForm&&(this.commentForm.destroy(),this.commentForm=null),this.commentList&&(this.commentList.destroy(),this.commentList=null),this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.hostElement)for(;this.hostElement.firstChild;)this.hostElement.removeChild(this.hostElement.firstChild);this.shadowRoot=null,this.mountPoint=null,this.store=null,this._mounted=!1,console.log("[CWDComments] 组件已卸载")}}_render(){if(!this.mountPoint)return;const t=this.store.store.getState();this.commentForm||(this.commentForm=new s(this.mountPoint,{form:t.form,formErrors:t.formErrors,submitting:t.submitting,onSubmit:()=>this._handleSubmit(),onFieldChange:(t,e)=>this.store.updateFormField(t,e)}),this.commentForm.render());const e=this.mountPoint.querySelector(".cwd-error-inline");if(t.error){if(!e){const e=document.createElement("div");e.className="cwd-error-inline",e.innerHTML=`\n          <span>${t.error}</span>\n          <button type="button" class="cwd-error-close" data-action="clear-error">✕</button>\n        `,e.querySelector('[data-action="clear-error"]').addEventListener("click",()=>{this.store.clearError()}),this.mountPoint.insertBefore(e,this.mountPoint.firstChild)}}else e&&e.remove();let r=this.mountPoint.querySelector(".cwd-comments-header");r||(r=document.createElement("div"),r.className="cwd-comments-header",r.innerHTML='\n        <h3 class="cwd-comments-count">\n          共 <span class="cwd-comments-count-number">0</span> 条评论\n        </h3>\n      ',this.mountPoint.appendChild(r));const o=r.querySelector(".cwd-comments-count-number");if(o&&(o.textContent=t.pagination.totalCount),!this.commentList){const e=document.createElement("div");this.mountPoint.appendChild(e),this.commentList=new m(e,{comments:t.comments,loading:t.loading,error:null,currentPage:t.pagination.page,totalPages:this.store.getTotalPages(),replyingTo:t.replyingTo,replyContent:t.replyContent,replyError:t.replyError,submitting:t.submitting,adminEmail:this.config.adminEmail,adminBadge:this.config.adminBadge||"博主",onRetry:()=>this.store.loadComments(),onReply:t=>this.store.startReply(t),onSubmitReply:t=>this.store.submitReply(t),onCancelReply:()=>this.store.cancelReply(),onUpdateReplyContent:t=>this.store.updateReplyContent(t),onClearReplyError:()=>this.store.clearReplyError(),onPrevPage:()=>this.store.goToPage(t.pagination.page-1),onNextPage:()=>this.store.goToPage(t.pagination.page+1),onGoToPage:t=>this.store.goToPage(t)}),this.commentList.render()}}_onStateChange(t,e){var r,o,n,i,s;if(!this._mounted)return;if(null==(o=null==(r=this.commentForm)?void 0:r.elements)?void 0:o.root){const e=this.commentForm.elements.root;null!==t.replyingTo?e.style.display="none":e.style.display=""}this.commentForm&&this.commentForm.setProps({form:t.form,formErrors:t.formErrors,submitting:t.submitting});const a=null==(n=this.mountPoint)?void 0:n.querySelector(".cwd-error-inline");if(t.error){if(!a){const e=document.createElement("div");e.className="cwd-error-inline",e.innerHTML=`\n          <span>${t.error}</span>\n          <button type="button" class="cwd-error-close" data-action="clear-error">✕</button>\n        `,e.querySelector('[data-action="clear-error"]').addEventListener("click",()=>{this.store.clearError()}),null==(i=this.mountPoint)||i.insertBefore(e,this.mountPoint.firstChild)}}else a&&a.remove();const l=null==(s=this.mountPoint)?void 0:s.querySelector(".cwd-comments-header"),c=null==l?void 0:l.querySelector(".cwd-comments-count-number");c&&(c.textContent=t.pagination.totalCount),this.commentList&&this.commentList.setProps({comments:t.comments,loading:t.loading,currentPage:t.pagination.page,totalPages:this.store.getTotalPages(),replyingTo:t.replyingTo,replyContent:t.replyContent,replyError:t.replyError,submitting:t.submitting})}async _handleSubmit(){await this.store.submitNewComment()&&this.commentForm&&(this.commentForm.state.localForm={...this.store.store.getState().form})}updateConfig(t){const r={...this.config};if(Object.assign(this.config,t),t.theme&&this.mountPoint&&this.mountPoint.setAttribute("data-theme",t.theme),t.postSlug&&t.postSlug!==r.postSlug){const t=e(this.config);this.unsubscribe&&this.unsubscribe(),this.store=n(this.config,t.fetchComments.bind(t),t.submitComment.bind(t)),this.unsubscribe=this.store.store.subscribe(t=>{this._onStateChange(t)}),this.store.loadComments()}}getConfig(){return{...this.config}}}function u(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}function g(t){if(!t)return!0;try{return new URL(t),!0}catch{return!1}}function f(t){return t&&0!==t.trim().length?t.length>1e3?{valid:!1,error:"评论内容不能超过 1000 字"}:{valid:!0}:{valid:!1,error:"请输入评论内容"}}"undefined"!=typeof window&&(window.CWDComments=h);const b=Object.freeze(Object.defineProperty({__proto__:null,isValidEmail:u,isValidUrl:g,validateCommentContent:f,validateCommentForm:function(t){const e={};t.author&&0!==t.author.trim().length?t.author.length>50&&(e.author="昵称不能超过 50 字"):e.author="请输入昵称",t.email&&0!==t.email.trim().length?u(t.email)||(e.email="邮箱格式不正确"):e.email="请输入邮箱",t.url&&!g(t.url)&&(e.url="网址格式不正确");const r=f(t.content);return r.valid||(e.content=r.error),{valid:0===Object.keys(e).length,errors:e}},validateReplyUserInfo:function(t){const e={};return t.author&&0!==t.author.trim().length?t.author.length>50&&(e.author="昵称不能超过 50 字"):e.author="请输入昵称",t.email&&0!==t.email.trim().length?u(t.email)||(e.email="邮箱格式不正确"):e.email="请输入邮箱",t.url&&!g(t.url)&&(e.url="网址格式不正确"),{valid:0===Object.keys(e).length,errors:e}}},Symbol.toStringTag,{value:"Module"}));t.CWDComments=h,t.default=h,Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
