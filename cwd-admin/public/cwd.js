!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).CWDComments={})}(this,function(e){"use strict";function t(e){const t=e.apiBaseUrl.replace(/\/$/,"");return{fetchComments:async function(r=1,n=20){const o=new URLSearchParams({post_slug:e.postSlug,page:r.toString(),limit:n.toString(),nested:"true"});e.avatarPrefix&&o.set("avatar_prefix",e.avatarPrefix);const i=await fetch(`${t}/api/comments?${o}`);if(!i.ok)throw new Error(`获取评论失败：${i.status} ${i.statusText}`);return i.json()},submitComment:async function(r){const n=await fetch(`${t}/api/comments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({post_slug:e.postSlug,post_title:e.postTitle,post_url:e.postUrl,name:r.name,email:r.email,url:r.url||void 0,content:r.content,parent_id:r.parentId,adminToken:r.adminToken})});if(!n.ok){let e=n.statusText;try{const t=await n.json();t.message&&(e=t.message)}catch(o){}throw new Error(e)}return n.json()},verifyAdminKey:async function(e){const r=await fetch(`${t}/api/verify-admin`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({adminToken:e})});if(!r.ok){let e=r.statusText;try{const t=await r.json();t.message&&(e=t.message)}catch(n){}throw new Error(e)}return r.json()}}}const r="cwd_admin_auth",n="cwd-salt";function o(e){try{const t=e=>e.split("").map(e=>e.charCodeAt(0)),r=e=>("0"+Number(e).toString(16)).substr(-2),o=e=>t(n).reduce((e,t)=>e^t,e);return e.split("").map(t).map(o).map(r).join("")}catch(t){return btoa(e)}}const i={saveToken(e){const t={adminToken:o(e),timestamp:Date.now()};localStorage.setItem(r,JSON.stringify(t))},getToken(){try{const e=localStorage.getItem(r);if(!e)return null;const t=JSON.parse(e);return Date.now()-t.timestamp>432e5?(this.clearToken(),null):function(e){try{const t=e=>e.split("").map(e=>e.charCodeAt(0)),r=e=>t(n).reduce((e,t)=>e^t,e);return e.match(/.{1,2}/g).map(e=>parseInt(e,16)).map(r).map(e=>String.fromCharCode(e)).join("")}catch(t){return atob(e)}}(t.adminToken)}catch(e){return this.clearToken(),null}},clearToken(){localStorage.removeItem(r)},hasToken(){return!!this.getToken()}},s="cwd_user_info";class a{constructor(e){this.state={...e},this.listeners=[]}getState(){return{...this.state}}setState(e){const t={...this.state};this.state={...this.state,...e},this.listeners.forEach(e=>{e(this.state,t)})}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}}function l(e,t,r){const n=function(){try{const e=localStorage.getItem(s);if(e){const t=JSON.parse(e);return{name:t.name||"",email:t.email||"",url:t.url||""}}}catch(e){}return{name:"",email:"",url:""}}(),o=new a({comments:[],loading:!0,error:null,successMessage:"",pagination:{page:1,limit:e.pageSize||20,total:0,totalCount:0},form:{name:n.name||"",email:n.email||"",url:n.url||"",content:""},formErrors:{},submitting:!1,replyingTo:null,replyContent:"",replyError:null});async function l(e=1){o.setState({loading:!0,error:null});try{const r=await t(e,o.getState().pagination.limit);o.setState({comments:r.data,pagination:{page:r.pagination.page,limit:r.pagination.limit,total:r.pagination.total,totalCount:r.pagination.totalCount},loading:!1})}catch(r){o.setState({error:r instanceof Error?r.message:"加载评论失败",loading:!1})}}return o.subscribe(e=>{(e.form.name||e.form.email||e.form.url)&&function(e,t,r){try{const n={name:e,email:t,url:r};localStorage.setItem(s,JSON.stringify(n))}catch(n){}}(e.form.name,e.form.email,e.form.url)}),{store:o,getTotalPages:()=>o.getState().pagination.total,loadComments:l,submitNewComment:async function(){const t=o.getState(),n=t.form,{validateCommentForm:s}=await Promise.resolve().then(()=>E),a=s(n);if(!a.valid)return o.setState({formErrors:a.errors}),!1;o.setState({formErrors:{},submitting:!0,error:null,successMessage:""});try{const s=await r({name:n.name,email:n.email,url:n.url,content:n.content,adminToken:i.getToken()}),a=s&&"string"==typeof s.message?s.message:e.requireReview?"已提交评论，待管理员审核后显示":"评论已提交";return o.setState({form:{...n,content:""},submitting:!1,successMessage:a}),await l(t.pagination.page),!0}catch(d){return o.setState({error:d instanceof Error?d.message:"提交评论失败",submitting:!1,successMessage:""}),!1}},submitReply:async function(e){const t=o.getState();if(!t.replyContent.trim())return!1;const{validateReplyUserInfo:n}=await Promise.resolve().then(()=>E),s=n(t.form);if(!s.valid){const e=Object.values(s.errors).join("；");return o.setState({replyError:e}),!1}o.setState({formErrors:{},submitting:!0,replyError:null});try{return await r({name:t.form.name,email:t.form.email,url:t.form.url,content:t.replyContent,parentId:e,adminToken:i.getToken()}),o.setState({replyContent:"",replyingTo:null,submitting:!1}),await l(t.pagination.page),!0}catch(a){return o.setState({error:a instanceof Error?a.message:"提交回复失败",submitting:!1}),!1}},startReply:function(e){o.setState({replyingTo:e,replyContent:"",replyError:null})},cancelReply:function(){o.setState({replyingTo:null,replyContent:"",replyError:null})},updateFormField:function(e,t){const r={...o.getState().form};r[e]=t,o.setState({form:r})},updateReplyContent:function(e){o.setState({replyContent:e})},clearReplyError:function(){o.setState({replyError:null})},clearError:function(){o.setState({error:null})},clearSuccess:function(){o.setState({successMessage:""})},goToPage:function(e){const t=o.getState().pagination.total;e>=1&&e<=t&&l(e)}}}class d{constructor(e,t={}){this.container="string"==typeof e?document.querySelector(e):e,this.props=t,this.state={},this.elements={},this.destroyed=!1}setState(e){if(this.destroyed)return;const t={...this.state};this.state="function"==typeof e?{...this.state,...e(t)}:{...this.state,...e},this.update(t)}setProps(e){if(this.destroyed)return;const t={...this.props};this.props={...this.props,...e},this.updateProps(t)}render(){}update(e){this.render()}updateProps(e){}destroy(){this.destroyed=!0,this.container&&this.elements.root&&this.elements.root.parentNode&&this.elements.root.parentNode.removeChild(this.elements.root),this.elements={}}createElement(e,t={}){const r=document.createElement(e);if(t.className&&(r.className=t.className),t.attributes&&Object.entries(t.attributes).forEach(([e,t])=>{if(e.startsWith("on")){const n=e.slice(2).toLowerCase();r.addEventListener(n,t)}else"dataset"===e?Object.entries(t).forEach(([e,t])=>{r.dataset[e]=t}):["disabled","checked","readonly","required","autofocus"].includes(e)?t&&r.setAttribute(e,""):r.setAttribute(e,t)}),void 0!==t.text&&(r.textContent=t.text),void 0!==t.html&&(r.innerHTML=t.html),t.children){(Array.isArray(t.children)?t.children:[t.children]).forEach(e=>{e instanceof HTMLElement&&r.appendChild(e)})}return r}createTextElement(e,t,r=""){return this.createElement(e,{className:r,text:t})}empty(e){for(;e.firstChild;)e.removeChild(e.firstChild)}}class c extends d{constructor(e,t={}){super(e,t),this.state={key:"",error:"",loading:!1},this.elements={input:null,error:null,submitBtn:null}}render(){const{key:e,error:t,loading:r}=this.state,n=this.createElement("div",{className:"cwd-modal-overlay",children:[this.createElement("div",{className:"cwd-modal",children:[this.createTextElement("h3","管理员身份验证","cwd-modal-title"),this.createElement("div",{className:"cwd-modal-body",children:[this.createTextElement("p","检测到管理员邮箱，请输入密钥以继续。","cwd-modal-desc"),this.createElement("input",{className:"cwd-form-input "+(t?"cwd-input-error":""),attributes:{type:"password",placeholder:"请输入管理员密钥",value:e,disabled:r,onInput:e=>this.setState({key:e.target.value,error:""}),onKeydown:e=>{"Enter"===e.key&&this.handleSubmit()}}}),t?this.createTextElement("div",t,"cwd-error-text"):null]}),this.createElement("div",{className:"cwd-modal-actions",children:[this.createElement("button",{className:"cwd-btn cwd-btn-secondary",text:"取消",attributes:{type:"button",disabled:r,onClick:()=>this.props.onCancel&&this.props.onCancel()}}),this.createElement("button",{className:"cwd-btn cwd-btn-primary",text:r?"验证中...":"验证",attributes:{type:"button",disabled:r||!e,onClick:()=>this.handleSubmit()}})]})]})]});this.empty(this.container),this.container.appendChild(n),this.elements.input=n.querySelector("input"),this.elements.error=n.querySelector(".cwd-error-text"),this.elements.submitBtn=n.querySelector(".cwd-btn-primary"),this.update();const o=this.elements.input;o&&setTimeout(()=>o.focus(),50)}setState(e){this.state={...this.state,...e},this.update()}update(){const{key:e,error:t,loading:r}=this.state;this.elements.input&&(this.elements.input.value=e,this.elements.input.disabled=r,t?this.elements.input.classList.add("cwd-input-error"):this.elements.input.classList.remove("cwd-input-error")),this.elements.error&&(t?(this.elements.error.textContent=t,this.elements.error.style.display=""):(this.elements.error.textContent="",this.elements.error.style.display="none")),this.elements.submitBtn&&(this.elements.submitBtn.disabled=r||!e,this.elements.submitBtn.textContent=r?"验证中...":"验证")}handleSubmit(){this.state.key&&this.props.onSubmit&&(this.setState({loading:!0}),this.props.onSubmit(this.state.key).catch(e=>{this.setState({error:e.message||"验证失败",loading:!1})}))}destroy(){this.empty(this.container)}}class p extends d{constructor(e,t={}){super(e,t),this.state={localForm:{...t.form}},this.modal=null}render(){const{formErrors:e,submitting:t}=this.props,{localForm:r}=this.state,n=r.name.trim()&&r.email.trim()&&r.content.trim(),o=this.props.adminEmail&&r.email.trim()===this.props.adminEmail&&i.hasToken(),s=this.createElement("form",{className:"cwd-comment-form",attributes:{novalidate:!0,onSubmit:e=>this.handleSubmit(e)},children:[this.createTextElement("h3","发表评论","cwd-form-title"),this.createElement("div",{className:"cwd-form-fields",children:[this.createElement("div",{className:"cwd-form-row",children:[this.createFormField("昵称 *","text","name",r.name,e.name),this.createElement("div",{className:"cwd-form-field-wrapper",children:[this.createFormField("邮箱 *","email","email",r.email,e.email),o?this.createElement("div",{className:"cwd-admin-controls",children:[this.createElement("button",{className:"cwd-btn-text",text:"退出验证",attributes:{type:"button",title:"清除管理员凭证",onClick:()=>{i.clearToken(),this.render()}}})]}):null]}),this.createFormField("网址","url","url",r.url,e.url)]}),this.createElement("div",{className:"cwd-form-field",children:[this.createTextElement("label","写下你的评论...","cwd-form-label"),this.createElement("textarea",{className:"cwd-form-textarea "+(e.content?"cwd-input-error":""),attributes:{placeholder:"",rows:4,disabled:t,onInput:e=>this.handleFieldChange("content",e.target.value)}}),...e.content?[this.createTextElement("span",e.content,"cwd-error-text")]:[]]})]}),this.createElement("div",{className:"cwd-form-actions",children:[this.createElement("button",{className:"cwd-btn cwd-btn-primary",attributes:{type:"submit",disabled:t||!n},text:t?"提交中...":"提交评论"})]})]});this.setInputValues(s,r),this.elements.root=s,this.empty(this.container),this.container.appendChild(s)}updateProps(e){if(!this.props.submitting&&this.props.form!==e.form){const e=this.state.localForm.name||"",t=this.state.localForm.email||"",r=this.state.localForm.url||"",n=this.state.localForm.content||"";this.state.localForm={name:this.props.form.name||e,email:this.props.form.email||t,url:this.props.form.url||r,content:void 0!==this.props.form.content?this.props.form.content:n},this.elements.root&&this.setInputValues(this.elements.root,this.state.localForm)}this.elements.root&&this.updateFormState()}updateFormState(){const{formErrors:e,submitting:t}=this.props,{localForm:r}=this.state,n=r.name.trim()&&r.email.trim()&&r.content.trim(),o=this.elements.root.querySelector('button[type="submit"]');o&&(o.disabled=t||!n,o.textContent=t?"提交中...":"提交评论");this.elements.root.querySelectorAll("input, textarea").forEach(e=>{e.disabled=t}),this.updateErrors(e)}updateErrors(e){if(!this.elements.root)return;const t=this.elements.root.querySelector('input[name="name"]');this.updateFieldError(t,null==e?void 0:e.name);const r=this.elements.root.querySelector('input[name="email"]');this.updateFieldError(r,null==e?void 0:e.email);const n=this.elements.root.querySelector('input[name="url"]');this.updateFieldError(n,null==e?void 0:e.url);const o=this.elements.root.querySelector("textarea");this.updateFieldError(o,null==e?void 0:e.content)}updateFieldError(e,t){if(!e)return;t?e.classList.add("cwd-input-error"):e.classList.remove("cwd-input-error");const r=e.parentElement;let n=r.querySelector(".cwd-error-text");t?(n||(n=document.createElement("span"),n.className="cwd-error-text",r.appendChild(n)),n.textContent=t):n&&n.remove()}createFormField(e,t,r,n,o,i=""){return this.createElement("div",{className:"cwd-form-field",children:[this.createTextElement("label",e,"cwd-form-label"),this.createElement("input",{className:"cwd-form-input "+(o?"cwd-input-error":""),attributes:{type:t,name:r,value:n||"",disabled:this.props.submitting,onInput:e=>this.handleFieldChange(r,e.target.value),onBlur:e=>{"email"===r&&this.handleEmailBlur(e.target.value)}}}),...o?[this.createTextElement("span",o,"cwd-error-text")]:[]]})}setInputValues(e,t){const r=e.querySelector('input[name="name"]'),n=e.querySelector('input[name="email"]'),o=e.querySelector('input[name="url"]'),i=e.querySelector("textarea");r&&(r.value=t.name||""),n&&(n.value=t.email||""),o&&(o.value=t.url||""),i&&(i.value=t.content||"")}handleFieldChange(e,t){this.state.localForm[e]=t,this.props.onFieldChange&&this.props.onFieldChange(e,t),this.elements.root&&this.updateFormState()}handleSubmit(e){e.preventDefault(),this.props.onSubmit&&this.props.onSubmit(this.state.localForm)}async handleEmailBlur(e){if(e&&this.props.adminEmail&&e.trim()===this.props.adminEmail){if(i.hasToken())return;this.showAuthModal()}}showAuthModal(){let e=this.elements.root.querySelector(".cwd-modal-container");e||(e=document.createElement("div"),e.className="cwd-modal-container",this.elements.root.appendChild(e)),this.modal=new c(e,{onCancel:()=>{this.modal.destroy(),this.modal=null},onSubmit:async e=>{this.props.onVerifyAdmin&&(await this.props.onVerifyAdmin(e),i.saveToken(e),this.modal.destroy(),this.modal=null)}}),this.modal.render()}}class m extends d{constructor(e,t={}){super(e,t),this.state={content:t.content||""}}render(){const e=this.createElement("div",{className:"cwd-reply-editor",children:[this.createElement("div",{className:"cwd-reply-header",children:[this.createTextElement("span",`回复 @${this.props.replyToAuthor}`,"cwd-reply-to"),this.createElement("button",{className:"cwd-btn-close",attributes:{type:"button",onClick:()=>this.handleCancel()},text:"✕"})]}),this.createElement("textarea",{className:"cwd-reply-textarea",attributes:{rows:3,placeholder:"写下你的回复...",disabled:this.props.submitting,onInput:e=>this.handleInput(e)}}),...this.props.error?[this.createElement("div",{className:"cwd-error-inline cwd-error-small",children:[this.createTextElement("span",this.props.error),this.createElement("button",{className:"cwd-error-close",attributes:{type:"button",onClick:()=>this.handleClearError()},text:"✕"})]})]:[],this.createElement("div",{className:"cwd-reply-actions",children:[this.createElement("button",{className:"cwd-btn cwd-btn-primary cwd-btn-small",attributes:{type:"button",disabled:this.props.submitting||!this.state.content.trim(),onClick:()=>this.handleSubmit()},text:this.props.submitting?"提交中...":"提交回复"}),this.createElement("button",{className:"cwd-btn cwd-btn-secondary cwd-btn-small",attributes:{type:"button",disabled:this.props.submitting,onClick:()=>this.handleCancel()},text:"取消"})]})]}),t=e.querySelector("textarea");t&&(t.value=this.state.content),this.elements.root=e,this.empty(this.container),this.container.appendChild(e)}updateProps(e){if(this.props.content!==this.state.content&&this.props.content!==(null==e?void 0:e.content))return this.state.content=this.props.content,void this.render();this.props.error===(null==e?void 0:e.error)&&this.props.submitting===(null==e?void 0:e.submitting)||this.render()}handleInput(e){var t;this.state.content=e.target.value;const r=null==(t=this.elements.root)?void 0:t.querySelector(".cwd-btn-primary");r&&(r.disabled=this.props.submitting||!this.state.content.trim()),this.props.onUpdate&&this.props.onUpdate(this.state.content)}handleSubmit(){this.props.onSubmit&&this.props.onSubmit()}handleCancel(){this.props.onCancel&&this.props.onCancel()}handleClearError(){this.props.onClearError&&this.props.onClearError()}setContent(e){var t;this.state.content=e;const r=null==(t=this.elements.root)?void 0:t.querySelector("textarea");r&&(r.value=e)}getContent(){return this.state.content}focus(){var e;const t=null==(e=this.elements.root)?void 0:e.querySelector("textarea");t&&t.focus()}}function h(e){const t=new Date(e),r=(new Date).getTime()-t.getTime(),n=Math.floor(r/1e3),o=Math.floor(n/60),i=Math.floor(o/60),s=Math.floor(i/24);return s<3?s>0?1===s?"昨天":`${s}天前`:i>0?`${i}小时前`:o>0?`${o}分钟前`:"刚刚":function(e){const t=new Date(e),r=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0"),i=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0"),a=String(t.getSeconds()).padStart(2,"0");return`${r}/${n}/${o} ${i}:${s}:${a}`}(e)}class u extends d{constructor(e,t={}){super(e,t),this.replyEditor=null,this.childCommentItems=[]}render(){const{comment:e,isReply:t,adminEmail:r,adminBadge:n}=this.props,o=this.props.replyingTo===e.id,i=r&&n&&e.email===r,s=this.createElement("div",{className:"cwd-comment-item "+(t?"cwd-comment-reply":""),children:[this.createElement("div",{className:"cwd-comment-avatar",children:[this.createElement("img",{attributes:{src:e.avatar,alt:e.name,loading:"lazy"}})]}),this.createElement("div",{className:"cwd-comment-body",children:[this.createElement("div",{className:"cwd-comment-header",children:[this.createElement("div",{className:"cwd-comment-author",children:[e.url?this.createElement("span",{className:"cwd-author-name",children:[this.createElement("a",{attributes:{href:e.url,target:"_blank",rel:"noopener noreferrer"},text:e.name})]}):this.createTextElement("span",e.name,"cwd-author-name"),...i?[this.createTextElement("span",`${n}`,"cwd-admin-badge")]:[],...e.replyToAuthor?[this.createTextElement("span"," 回复 ","cwd-reply-to-separator"),this.createTextElement("span",e.replyToAuthor,"cwd-reply-to-author")]:[]]}),this.createElement("div",{className:"cwd-comment-actions",children:[this.createElement("span",{className:"cwd-action-btn",attributes:{onClick:()=>this.handleReply()},text:"回复"}),this.createTextElement("span",h(e.created),"cwd-comment-time")]})]}),this.createElement("div",{className:"cwd-comment-content"}),this.createElement("div",{className:"cwd-reply-editor-container"}),...e.replies&&e.replies.length>0?[this.createElement("div",{className:"cwd-replies"})]:[]]})]}),a=s.querySelector(".cwd-comment-content");if(a&&(a.innerHTML=e.contentHtml),o){const t=s.querySelector(".cwd-reply-editor-container");t&&(this.replyEditor=new m(t,{replyToAuthor:e.name,content:this.props.replyContent,error:this.props.replyError,submitting:this.props.submitting,onUpdate:e=>this.handleUpdateReplyContent(e),onSubmit:()=>this.handleSubmitReply(),onCancel:()=>this.handleCancelReply(),onClearError:()=>this.handleClearReplyError()}),this.replyEditor.render(),this.replyEditor.focus())}else this.replyEditor=null;if(this.childCommentItems=[],e.replies&&e.replies.length>0){const t=s.querySelector(".cwd-replies");t&&e.replies.forEach(e=>{const r=new u(t,{comment:e,isReply:!0,replyingTo:this.props.replyingTo,replyContent:this.props.replyContent,replyError:this.props.replyError,submitting:this.props.submitting,adminEmail:this.props.adminEmail,adminBadge:this.props.adminBadge,onReply:this.props.onReply,onSubmitReply:this.props.onSubmitReply,onCancelReply:this.props.onCancelReply,onUpdateReplyContent:this.props.onUpdateReplyContent,onClearReplyError:this.props.onClearReplyError});r.render(),this.childCommentItems.push(r)})}this.elements.root=s,this.container.contains(s)?this.container.replaceChild(s,this.elements.root):this.container.appendChild(s)}updateProps(e){var t;const{comment:r}=this.props,n=e.replyingTo===r.id,o=this.props.replyingTo===r.id;if(this.props.comment===e.comment){if(o!==n){const e=null==(t=this.elements.root)?void 0:t.querySelector(":scope > .cwd-comment-body > .cwd-reply-editor-container");o&&e?(this.replyEditor=new m(e,{replyToAuthor:r.name,content:this.props.replyContent,error:this.props.replyError,submitting:this.props.submitting,onUpdate:e=>this.handleUpdateReplyContent(e),onSubmit:()=>this.handleSubmitReply(),onCancel:()=>this.handleCancelReply(),onClearError:()=>this.handleClearReplyError()}),this.replyEditor.render(),this.replyEditor.focus()):!o&&e&&(e.innerHTML="",this.replyEditor=null)}else o&&this.replyEditor&&this.replyEditor.setProps({content:this.props.replyContent,error:this.props.replyError,submitting:this.props.submitting});this.childCommentItems&&this.childCommentItems.length>0&&this.childCommentItems.forEach(e=>{e.setProps({replyingTo:this.props.replyingTo,replyContent:this.props.replyContent,replyError:this.props.replyError,submitting:this.props.submitting})})}else this.render()}handleReply(){this.props.onReply&&this.props.onReply(this.props.comment.id)}handleSubmitReply(){this.props.onSubmitReply&&this.props.onSubmitReply(this.props.comment.id)}handleCancelReply(){this.props.onCancelReply&&this.props.onCancelReply()}handleUpdateReplyContent(e){this.props.onUpdateReplyContent&&this.props.onUpdateReplyContent(e)}handleClearReplyError(){this.props.onClearReplyError&&this.props.onClearReplyError()}}class f extends d{constructor(e,t={}){super(e,{text:"加载中...",...t})}render(){const e=this.createElement("div",{className:"cwd-loading",children:[this.createElement("div",{className:"cwd-spinner"}),this.createTextElement("span",this.props.text,"cwd-loading-text")]});this.elements.root=e,this.empty(this.container),this.container.appendChild(e)}setText(e){this.props.text=e;const t=this.elements.root.querySelector(".cwd-loading-text");t&&(t.textContent=e)}}class g extends d{constructor(e,t={}){super(e,t),this.state={currentPage:t.currentPage||1,totalPages:t.totalPages||1}}getDisplayedPages(){const{currentPage:e,totalPages:t}=this.state,r=[],n=Math.max(1,e-Math.floor(2.5)),o=Math.min(t,n+5-1);for(let i=o-5+1;i<=o;i++)i>=1&&r.push(i);return r.slice(0,5)}render(){if(this.state.totalPages<=1)return void this.empty(this.container);const e=this.getDisplayedPages(),t=this.createElement("div",{className:"cwd-pagination",children:[this.createElement("button",{className:"cwd-page-btn",attributes:{type:"button",disabled:1===this.state.currentPage,onClick:()=>this.handlePrev()},text:"上一页"}),this.createElement("div",{className:"cwd-page-numbers",children:e.map(e=>this.createElement("button",{className:"cwd-page-num "+(e===this.state.currentPage?"cwd-page-num-active":""),attributes:{type:"button",onClick:()=>this.handleGoTo(e)},text:e.toString()}))}),this.createElement("button",{className:"cwd-page-btn",attributes:{type:"button",disabled:this.state.currentPage===this.state.totalPages,onClick:()=>this.handleNext()},text:"下一页"})]});this.elements.root=t,this.empty(this.container),this.container.appendChild(t)}updateProps(){this.state.currentPage=this.props.currentPage,this.state.totalPages=this.props.totalPages,this.render()}handlePrev(){this.props.onPrev&&this.props.onPrev()}handleNext(){this.props.onNext&&this.props.onNext()}handleGoTo(e){this.props.onGoTo&&this.props.onGoTo(e)}}class w extends d{constructor(e,t={}){super(e,t),this.loadingComponent=null,this.paginationComponent=null,this.commentItems=new Map}render(){const{comments:e,loading:t,error:r,currentPage:n,totalPages:o}=this.props;if(this.empty(this.container),t&&0===e.length)return this.loadingComponent=new f(this.container,{text:"加载评论中..."}),this.loadingComponent.render(),void(this.elements.root=this.loadingComponent.elements.root);if(r&&0===e.length){const e=this.createElement("div",{className:"cwd-error",children:[this.createTextElement("span",r),this.createElement("button",{className:"cwd-error-retry",attributes:{type:"button",onClick:()=>this.handleRetry()},text:"重试"})]});return this.elements.root=e,void this.container.appendChild(e)}const i=this.createElement("div",{className:"cwd-comment-list"});if(e.length>0){const t=this.createElement("div",{className:"cwd-comments"});this.commentItems.clear(),e.forEach((e,r)=>{const n=new u(t,{comment:e,replyingTo:this.props.replyingTo,replyContent:this.props.replyContent,replyError:this.props.replyError,submitting:this.props.submitting,adminEmail:this.props.adminEmail,adminBadge:this.props.adminBadge,onReply:e=>this.handleReply(e),onSubmitReply:e=>this.handleSubmitReply(e),onCancelReply:()=>this.handleCancelReply(),onUpdateReplyContent:e=>this.handleUpdateReplyContent(e),onClearReplyError:()=>this.handleClearReplyError()});n.render(),this.commentItems.set(e.id,n)}),i.appendChild(t)}else{const e=this.createElement("div",{className:"cwd-empty",children:[this.createTextElement("p","暂无评论，快来抢沙发吧！","cwd-empty-text")]});i.appendChild(e)}if(o>1){const e=this.createElement("div");i.appendChild(e),this.paginationComponent=new g(e,{currentPage:n,totalPages:o,onPrev:()=>this.handlePrevPage(),onNext:()=>this.handleNextPage(),onGoTo:e=>this.handleGoToPage(e)}),this.paginationComponent.render()}else this.paginationComponent=null;this.elements.root=i,this.container.appendChild(i)}updateProps(e){if(this.props.loading===e.loading||this.props.loading)if(this.props.comments===e.comments)if(this.props.replyingTo===e.replyingTo&&this.props.replyError===e.replyError&&this.props.submitting===e.submitting){if(this.paginationComponent){(this.props.currentPage!==e.currentPage||this.props.totalPages!==e.totalPages)&&(this.paginationComponent.props.currentPage=this.props.currentPage,this.paginationComponent.props.totalPages=this.props.totalPages,this.paginationComponent.updateProps())}}else this.commentItems.forEach(e=>{e.setProps({replyingTo:this.props.replyingTo,replyContent:this.props.replyContent,replyError:this.props.replyError,submitting:this.props.submitting})});else this.render();else this.render()}handleRetry(){this.props.onRetry&&this.props.onRetry()}handleReply(e){this.props.onReply&&this.props.onReply(e)}handleSubmitReply(e){this.props.onSubmitReply&&this.props.onSubmitReply(e)}handleCancelReply(){this.props.onCancelReply&&this.props.onCancelReply()}handleUpdateReplyContent(e){this.props.onUpdateReplyContent&&this.props.onUpdateReplyContent(e)}handleClearReplyError(){this.props.onClearReplyError&&this.props.onClearReplyError()}handlePrevPage(){this.props.onPrevPage&&this.props.onPrevPage()}handleNextPage(){this.props.onNextPage&&this.props.onNextPage()}handleGoToPage(e){this.props.onGoToPage&&this.props.onGoToPage(e)}}class b{constructor(e){this.config={...e},"undefined"!=typeof window&&(this.config.postSlug=window.location.origin+window.location.pathname),"undefined"!=typeof document&&(this.config.postTitle=document.title||this.config.postSlug),"undefined"!=typeof window&&(this.config.postUrl=window.location.href),this.hostElement=this._resolveElement(e.el),this.shadowRoot=null,this.mountPoint=null,this.commentForm=null,this.commentList=null,this.store=null,this.unsubscribe=null,this._mounted=!1}_resolveElement(e){if("string"==typeof e){const t=document.querySelector(e);if(!t)throw new Error(`元素未找到：${e}`);if(!(t instanceof HTMLElement))throw new Error(`目标不是 HTMLElement: ${e}`);return t}return e}async _loadServerConfig(){try{const e=this.config.apiBaseUrl;if(!e)return{};const t=e.replace(/\/$/,""),r=await fetch(`${t}/api/config/comments`);if(!r.ok)return{};const n=await r.json();return{adminEmail:n.adminEmail||"",adminBadge:n.adminBadge||"",adminEnabled:!!n.adminEnabled,avatarPrefix:n.avatarPrefix||"",allowedDomains:Array.isArray(n.allowedDomains)?n.allowedDomains:[]}}catch(e){return{}}}mount(){if(this._mounted)return;this.shadowRoot=this.hostElement.attachShadow({mode:"open"});const e=document.createElement("style");e.textContent=':root,[data-theme=light]{--cwd-primary: #0969da;--cwd-primary-hover: #0864ca;--cwd-text: #24292f;--cwd-text-secondary: #6e7781;--cwd-bg: #ffffff;--cwd-bg-input: #ffffff;--cwd-bg-secondary: #f6f8fa;--cwd-bg-reply: #f6f8fa;--cwd-bg-hover: #f6f8fa;--cwd-bg-disabled: #f6f8fa;--cwd-bg-avatar: #f6f8fa;--cwd-border: #d0d7de;--cwd-border-light: #eaeef2;--cwd-error: #cf222e;--cwd-bg-error: #ffebe9;--cwd-border-error: #fd8c73;--cwd-radius: 6px}[data-theme=dark]{--cwd-primary: #58a6ff;--cwd-primary-hover: #4094ff;--cwd-text: #c9d1d9;--cwd-text-secondary: #8b949e;--cwd-bg: #0d1117;--cwd-bg-input: #0d1117;--cwd-bg-secondary: #161b22;--cwd-bg-reply: #161b22;--cwd-bg-hover: #161b22;--cwd-bg-disabled: #161b22;--cwd-bg-avatar: #161b22;--cwd-border: #30363d;--cwd-border-light: #21262d;--cwd-error: #f85149;--cwd-bg-error: #3d1614;--cwd-border-error: #f85149}*{box-sizing:border-box;margin:0;padding:0}.cwd-container{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Noto Sans,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";font-size:14px;line-height:1.5;color:var(--cwd-text);background:var(--cwd-bg);word-wrap:break-word}.cwd-header{display:flex;align-items:center;justify-content:space-between;padding:16px 0;margin-bottom:16px;border-bottom:1px solid var(--cwd-border)}.cwd-count{font-size:16px;font-weight:600;color:var(--cwd-text)}.cwd-loading{display:flex;align-items:center;justify-content:center;gap:12px;padding:40px 20px;color:var(--cwd-text-secondary, #6e7781)}.cwd-spinner{width:20px;height:20px;border:2px solid var(--cwd-border, #d0d7de);border-top-color:var(--cwd-primary, #0969da);border-radius:50%;animation:cwd-spin .6s linear infinite}@keyframes cwd-spin{to{transform:rotate(360deg)}}.cwd-loading-text{font-size:14px}.cwd-comment-form{background:var(--cwd-bg, #ffffff);border:1px solid var(--cwd-border, #d0d7de);border-radius:var(--cwd-radius, 6px);padding:20px;margin-bottom:24px}.cwd-form-title{margin:0 0 16px;font-size:16px;font-weight:600;color:var(--cwd-text, #24292f)}.cwd-form-fields{display:flex;flex-direction:column;gap:12px}.cwd-form-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}@media(max-width:640px){.cwd-form-row{grid-template-columns:1fr}}.cwd-form-field{display:flex;flex-direction:column;gap:4px}.cwd-form-label{font-size:13px;font-weight:500;color:var(--cwd-text, #24292f)}.cwd-form-field input,.cwd-form-field textarea{width:100%;padding:8px 12px;font-size:14px;line-height:1.5;color:var(--cwd-text, #24292f);background:var(--cwd-bg-input, #ffffff);border:1px solid var(--cwd-border, #d0d7de);border-radius:var(--cwd-radius, 6px);transition:border-color .2s,box-shadow .2s;font-family:inherit}.cwd-form-field input:focus,.cwd-form-field textarea:focus{outline:none;border-color:var(--cwd-primary, #0969da);box-shadow:0 0 0 3px #0969da1a}.cwd-form-field input:disabled,.cwd-form-field textarea:disabled{background:var(--cwd-bg-disabled, #f6f8fa);cursor:not-allowed}.cwd-form-field input.cwd-input-error,.cwd-form-field textarea.cwd-input-error{border-color:var(--cwd-error, #cf222e)}.cwd-form-field textarea{resize:vertical;min-height:80px}.cwd-error-text{font-size:12px;color:var(--cwd-error, #cf222e)}.cwd-form-actions{display:flex;justify-content:flex-end;margin-top:16px}.cwd-btn{padding:8px 16px;font-size:14px;font-weight:500;line-height:1.5;border:none;border-radius:var(--cwd-radius, 6px);cursor:pointer;transition:background-color .2s;font-family:inherit}.cwd-btn-primary{color:#fff;background:var(--cwd-primary, #0969da)}.cwd-btn-primary:hover:not(:disabled){background:var(--cwd-primary-hover, #0864ca)}.cwd-btn:disabled{opacity:.6;cursor:not-allowed}.cwd-reply-editor{margin-top:12px;padding:12px;background:var(--cwd-bg-reply, #f6f8fa);border:1px solid var(--cwd-border, #d0d7de);border-radius:var(--cwd-radius, 6px)}.cwd-reply-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.cwd-reply-to{font-size:13px;font-weight:500;color:var(--cwd-text-secondary, #6e7781)}.cwd-btn-close{width:20px;height:20px;padding:0;font-size:14px;color:var(--cwd-text-secondary, #6e7781);background:transparent;border:none;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color .2s}.cwd-btn-close:hover{background:var(--cwd-bg-hover, rgba(0, 0, 0, .05))}.cwd-reply-textarea{width:100%;padding:8px 12px;font-size:14px;line-height:1.5;color:var(--cwd-text, #24292f);background:var(--cwd-bg-input, #ffffff);border:1px solid var(--cwd-border, #d0d7de);border-radius:var(--cwd-radius, 6px);resize:vertical;font-family:inherit;margin-bottom:8px}.cwd-reply-textarea:focus{outline:none;border-color:var(--cwd-primary, #0969da);box-shadow:0 0 0 3px #0969da1a}.cwd-reply-actions{display:flex;gap:8px;justify-content:flex-end}.cwd-btn-small{padding:4px 10px;font-size:12px}.cwd-btn-secondary{color:var(--cwd-text, #24292f);background:var(--cwd-bg-secondary, #f6f8fa);border:1px solid var(--cwd-border, #d0d7de)}.cwd-btn-secondary:hover:not(:disabled){background:var(--cwd-bg-hover, #eaeef2)}.cwd-comment-item{display:flex;gap:12px;padding:20px 0;border-bottom:1px solid var(--cwd-border-light, #eaeef2)}.cwd-comment-body:hover .cwd-action-btn{display:inline-flex!important}.cwd-comment-item:last-child{border-bottom:none}.cwd-comment-reply{padding-top:12px;padding-bottom:12px}.cwd-comment-avatar{flex-shrink:0;width:40px;height:40px;border-radius:5px;overflow:hidden;background:var(--cwd-bg-avatar, #f6f8fa)}.cwd-comment-avatar img{width:100%;height:100%;object-fit:cover}.cwd-comment-reply .cwd-comment-avatar{width:32px;height:32px}.cwd-comment-body{flex:1;min-width:0}.cwd-comment-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:4px}.cwd-author-name{font-size:16px;font-weight:600;color:var(--cwd-text, #24292f)}.cwd-author-name a{color:inherit;text-decoration:none}.cwd-author-name a:hover{color:var(--cwd-primary, #0969da);text-decoration:underline}.cwd-comment-author{display:inline-flex;align-items:center}.cwd-admin-badge{background:#db850d;color:#fff;border-radius:3px;padding:1px 4px;font-size:12px;margin:0 4px}.cwd-reply-to-separator{margin:0 4px}.cwd-reply-to-author{font-style:italic}.cwd-comment-time{font-size:12px;color:var(--cwd-text-secondary, #6e7781)}.cwd-comment-content{font-size:14px;line-height:1.6;color:var(--cwd-text, #24292f);word-wrap:break-word;margin-top:10px}.cwd-comment-content p{margin:0 0 8px}.cwd-comment-content p:last-child{margin-bottom:0}.cwd-comment-content a{color:var(--cwd-primary, #0969da);text-decoration:none}.cwd-comment-content a:hover{text-decoration:underline}.cwd-comment-content h1,.cwd-comment-content h2,.cwd-comment-content h3,.cwd-comment-content h4,.cwd-comment-content h5,.cwd-comment-content h6{margin-top:16px;margin-bottom:8px;font-weight:600;line-height:1.25}.cwd-comment-content h1{font-size:1.5em}.cwd-comment-content h2{font-size:1.3em}.cwd-comment-content h3{font-size:1.1em}.cwd-comment-content ul,.cwd-comment-content ol{padding-left:1.7em;margin:0 0 8px}.cwd-comment-content li+li{margin-top:4px}.cwd-comment-content code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-size:.9em;background:var(--cwd-bg-secondary, #f6f8fa);padding:.2em .4em;border-radius:4px}.cwd-comment-content pre{padding:12px;margin:12px 0;overflow-x:auto;background:var(--cwd-bg-secondary, #f6f8fa);border-radius:6px;font-size:.9em}.cwd-comment-content pre code{padding:0;background:transparent;border-radius:0;display:block}.cwd-comment-content blockquote{margin:8px 0;padding:0 12px;border-left:4px solid var(--cwd-border, #d0d7de);color:var(--cwd-text-secondary, #6e7781)}.cwd-comment-content hr{border:0;border-top:1px solid var(--cwd-border-light, #eaeef2);margin:16px 0}.cwd-comment-content table{border-collapse:collapse;border-spacing:0;width:100%;font-size:13px;margin:12px 0}.cwd-comment-content th,.cwd-comment-content td{border:1px solid var(--cwd-border, #d0d7de);padding:6px 12px;text-align:left}.cwd-comment-content th{background:var(--cwd-bg-secondary, #f6f8fa)}.cwd-comment-content img{max-width:100%;height:auto}.cwd-comment-actions{display:flex;align-items:center;gap:12px}.cwd-action-btn{display:inline-flex;align-items:center;font-size:12px;color:var(--cwd-text-secondary, #6e7781);background:transparent;border:none;border-radius:4px;cursor:pointer;transition:background-color .2s;font-family:inherit;display:none}.cwd-action-btn:hover{color:var(--cwd-primary, #0969da)}.cwd-replies{margin-top:12px;padding-left:12px;border-left:2px solid var(--cwd-border-light, #eaeef2)}.cwd-comment-list{min-height:100px}.cwd{display:flex;flex-direction:column}.cwd-error{padding:20px;text-align:center;color:var(--cwd-error, #cf222e);background:var(--cwd-bg-error, #ffebe9);border:1px solid var(--cwd-border-error, #fd8c73);border-radius:var(--cwd-radius, 6px)}.cwd-error-retry{margin-left:12px;padding:4px 12px;font-size:13px;color:#fff;background:var(--cwd-primary, #0969da);border:none;border-radius:4px;cursor:pointer;font-family:inherit}.cwd-error-retry:hover{background:var(--cwd-primary-hover, #0864ca)}.cwd-empty{padding:40px 20px;text-align:center}.cwd-empty-icon{font-size:48px;margin-bottom:12px}.cwd-empty-text{margin:0;font-size:14px;color:var(--cwd-text-secondary, #6e7781)}.cwd-pagination{display:flex;align-items:center;justify-content:center;gap:8px;padding:20px 0}.cwd-page-btn{padding:6px 12px;font-size:13px;color:var(--cwd-text, #24292f);background:var(--cwd-bg, #ffffff);border:1px solid var(--cwd-border, #d0d7de);border-radius:var(--cwd-radius, 6px);cursor:pointer;transition:background-color .2s;font-family:inherit}.cwd-page-btn:hover:not(:disabled){background:var(--cwd-bg-hover, #f6f8fa)}.cwd-page-btn:disabled{opacity:.5;cursor:not-allowed}.cwd-page-numbers{display:flex;gap:4px}.cwd-page-num{min-width:32px;padding:6px 8px;font-size:13px;color:var(--cwd-text, #24292f);background:var(--cwd-bg, #ffffff);border:1px solid var(--cwd-border, #d0d7de);border-radius:var(--cwd-radius, 6px);cursor:pointer;transition:background-color .2s;font-family:inherit}.cwd-page-num-active{color:#fff;background:var(--cwd-primary, #0969da);border-color:var(--cwd-primary, #0969da)}.cwd-error-inline{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;margin-bottom:16px;font-size:14px;color:var(--cwd-error, #cf222e);background:var(--cwd-bg-error, #ffebe9);border:1px solid var(--cwd-border-error, #fd8c73);border-radius:var(--cwd-radius, 6px)}.cwd-error-close{width:20px;height:20px;padding:0;font-size:14px;color:inherit;background:transparent;border:none;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color .2s}.cwd-error-close:hover{background:#0000001a}.cwd-success-inline{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;margin-bottom:16px;font-size:14px;color:#1a7f37;background:#dafbe1;border:1px solid #54ae65;border-radius:var(--cwd-radius, 6px)}.cwd-load-more{display:block;width:100%;padding:12px;margin:16px 0;font-size:14px;color:var(--cwd-primary);background:var(--cwd-bg-secondary);border:1px solid var(--cwd-border);border-radius:var(--cwd-radius);cursor:pointer;transition:background-color .2s;font-family:inherit}.cwd-load-more:hover{background:var(--cwd-bg-hover)}.fade-enter-active,.fade-leave-active{transition:opacity .2s ease}.fade-enter-from,.fade-leave-to{opacity:0}.cwd-container::-webkit-scrollbar{width:8px;height:8px}.cwd-container::-webkit-scrollbar-track{background:transparent}.cwd-container::-webkit-scrollbar-thumb{background:var(--cwd-border);border-radius:4px}.cwd-container::-webkit-scrollbar-thumb:hover{background:var(--cwd-text-secondary)}.cwd-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:10000;-webkit-backdrop-filter:blur(2px);backdrop-filter:blur(2px)}.cwd-modal{background:var(--cwd-bg, #ffffff);border-radius:var(--cwd-radius, 6px);width:90%;max-width:400px;box-shadow:0 8px 24px #0003;border:1px solid var(--cwd-border, #d0d7de);overflow:hidden;animation:cwd-modal-in .2s ease-out}@keyframes cwd-modal-in{0%{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}.cwd-modal-title{margin:0;padding:16px 20px;border-bottom:1px solid var(--cwd-border, #d0d7de);font-size:16px;font-weight:600;color:var(--cwd-text, #24292f)}.cwd-modal-body{padding:20px}.cwd-modal-desc{margin:0 0 16px;font-size:14px;color:var(--cwd-text-secondary, #6e7781)}.cwd-form-input{width:100%;padding:8px 12px;font-size:14px;line-height:1.5;color:var(--cwd-text, #24292f);background:var(--cwd-bg-input, #ffffff);border:1px solid var(--cwd-border, #d0d7de);border-radius:var(--cwd-radius, 6px);transition:border-color .2s,box-shadow .2s;font-family:inherit}.cwd-modal-actions{padding:16px 20px;background:var(--cwd-bg-secondary, #f6f8fa);border-top:1px solid var(--cwd-border, #d0d7de);display:flex;justify-content:flex-end;gap:12px}.cwd-form-field-wrapper{display:flex;flex-direction:column;gap:4px;position:relative}.cwd-admin-controls{position:absolute;top:0;right:0;display:flex;align-items:center;gap:8px;font-size:12px}.cwd-admin-verified{color:#1a7f37;font-weight:500}.cwd-btn-text{background:none;border:none;padding:0;color:var(--cwd-text-secondary);font-size:12px;cursor:pointer;text-decoration:underline}.cwd-btn-text:hover{color:var(--cwd-primary)}',this.shadowRoot.appendChild(e),this.mountPoint=document.createElement("div"),this.mountPoint.className="cwd-comments-container",this.shadowRoot.appendChild(this.mountPoint),this.config.theme&&this.mountPoint.setAttribute("data-theme",this.config.theme),(async()=>{const e=await this._loadServerConfig();if(!this._mounted)return;if(e.allowedDomains&&e.allowedDomains.length>0&&"undefined"!=typeof window){const t=window.location.hostname;if(!e.allowedDomains.some(e=>t===e||t.endsWith("."+e)))return void(this.mountPoint.innerHTML=`\n            <div style="padding: 20px; text-align: center; color: #666; font-size: 14px; border: 1px solid #eee; border-radius: 8px; background: #f9f9f9;">\n              当前域名 (${t}) 未获得评论组件调用授权\n            </div>\n          `)}e.avatarPrefix&&(this.config.avatarPrefix=e.avatarPrefix),e.adminEmail&&(this.config.adminEmail=e.adminEmail),e.adminEnabled&&e.adminBadge&&(this.config.adminBadge=e.adminBadge),this.config.requireReview=!!e.requireReview;const r=t(this.config);this.api=r,this.store=l(this.config,r.fetchComments.bind(r),r.submitComment.bind(r)),this.unsubscribe=this.store.store.subscribe(e=>{this._onStateChange(e)}),this._render(),this.store.loadComments()})(),this._mounted=!0}unmount(){if(this._mounted){if(this.commentForm&&(this.commentForm.destroy(),this.commentForm=null),this.commentList&&(this.commentList.destroy(),this.commentList=null),this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.hostElement)for(;this.hostElement.firstChild;)this.hostElement.removeChild(this.hostElement.firstChild);this.shadowRoot=null,this.mountPoint=null,this.store=null,this._mounted=!1}}_render(){if(!this.mountPoint)return;const e=this.store.store.getState();this.commentForm||(this.commentForm=new p(this.mountPoint,{form:e.form,formErrors:e.formErrors,submitting:e.submitting,onSubmit:()=>this._handleSubmit(),onFieldChange:(e,t)=>this.store.updateFormField(e,t),adminEmail:this.config.adminEmail,onVerifyAdmin:e=>this.api.verifyAdminKey(e)}),this.commentForm.render());const t=this.mountPoint.querySelector(".cwd-error-inline");if(e.error){if(!t){const t=document.createElement("div");t.className="cwd-error-inline",t.innerHTML=`\n          <span>${e.error}</span>\n          <button type="button" class="cwd-error-close" data-action="clear-error">✕</button>\n        `,t.querySelector('[data-action="clear-error"]').addEventListener("click",()=>{this.store.clearError()}),this.mountPoint.insertBefore(t,this.mountPoint.firstChild)}}else t&&t.remove();const r=this.mountPoint.querySelector(".cwd-success-inline");if(e.successMessage)if(r){const t=r.querySelector("span");t&&(t.textContent=e.successMessage)}else{const t=document.createElement("div");t.className="cwd-success-inline",t.innerHTML=`\n          <span>${e.successMessage}</span>\n          <button type="button" class="cwd-error-close" data-action="clear-success">✕</button>\n        `,t.querySelector('[data-action="clear-success"]').addEventListener("click",()=>{this.store.clearSuccess()}),this.mountPoint.insertBefore(t,this.mountPoint.firstChild)}else r&&r.remove();let n=this.mountPoint.querySelector(".cwd-header");n||(n=document.createElement("div"),n.className="cwd-comments-header",n.innerHTML='\n        <h3 class="cwd-comments-count">\n          共 <span class="cwd-comments-count-number">0</span> 条评论\n        </h3>\n      ',this.mountPoint.appendChild(n));const o=n.querySelector(".cwd-count-number");if(o&&(o.textContent=e.pagination.totalCount),!this.commentList){const t=document.createElement("div");this.mountPoint.appendChild(t),this.commentList=new w(t,{comments:e.comments,loading:e.loading,error:null,currentPage:e.pagination.page,totalPages:this.store.getTotalPages(),replyingTo:e.replyingTo,replyContent:e.replyContent,replyError:e.replyError,submitting:e.submitting,adminEmail:this.config.adminEmail,adminBadge:this.config.adminBadge,onRetry:()=>this.store.loadComments(),onReply:e=>this.store.startReply(e),onSubmitReply:e=>this.store.submitReply(e),onCancelReply:()=>this.store.cancelReply(),onUpdateReplyContent:e=>this.store.updateReplyContent(e),onClearReplyError:()=>this.store.clearReplyError(),onPrevPage:()=>this.store.goToPage(e.pagination.page-1),onNextPage:()=>this.store.goToPage(e.pagination.page+1),onGoToPage:e=>this.store.goToPage(e)}),this.commentList.render()}}_onStateChange(e,t){var r,n,o,i,s,a,l;if(!this._mounted)return;if(null==(n=null==(r=this.commentForm)?void 0:r.elements)?void 0:n.root){const t=this.commentForm.elements.root;null!==e.replyingTo?t.style.display="none":t.style.display=""}this.commentForm&&this.commentForm.setProps({form:e.form,formErrors:e.formErrors,submitting:e.submitting,adminEmail:this.config.adminEmail});const d=null==(o=this.mountPoint)?void 0:o.querySelector(".cwd-error-inline");if(e.error){if(!d){const t=document.createElement("div");t.className="cwd-error-inline",t.innerHTML=`\n          <span>${e.error}</span>\n          <button type="button" class="cwd-error-close" data-action="clear-error">✕</button>\n        `,t.querySelector('[data-action="clear-error"]').addEventListener("click",()=>{this.store.clearError()}),null==(i=this.mountPoint)||i.insertBefore(t,this.mountPoint.firstChild)}}else d&&d.remove();const c=null==(s=this.mountPoint)?void 0:s.querySelector(".cwd-success-inline");if(e.successMessage)if(c){const t=c.querySelector("span");t&&(t.textContent=e.successMessage)}else{const t=document.createElement("div");t.className="cwd-success-inline",t.innerHTML=`\n          <span>${e.successMessage}</span>\n          <button type="button" class="cwd-error-close" data-action="clear-success">✕</button>\n        `,t.querySelector('[data-action="clear-success"]').addEventListener("click",()=>{this.store.clearSuccess()}),null==(a=this.mountPoint)||a.insertBefore(t,this.mountPoint.firstChild)}else c&&c.remove();const p=null==(l=this.mountPoint)?void 0:l.querySelector(".cwd-header"),m=null==p?void 0:p.querySelector(".cwd-count-number");m&&(m.textContent=e.pagination.totalCount),this.commentList&&this.commentList.setProps({comments:e.comments,loading:e.loading,currentPage:e.pagination.page,totalPages:this.store.getTotalPages(),replyingTo:e.replyingTo,replyContent:e.replyContent,replyError:e.replyError,submitting:e.submitting})}async _handleSubmit(){await this.store.submitNewComment()&&this.commentForm&&(this.commentForm.state.localForm={...this.store.store.getState().form})}updateConfig(e){const r={...this.config};Object.assign(this.config,e),"undefined"!=typeof window&&(this.config.postSlug=window.location.origin+window.location.pathname),"undefined"!=typeof document&&(this.config.postTitle=document.title||this.config.postSlug),"undefined"!=typeof window&&(this.config.postUrl=window.location.href),e.theme&&this.mountPoint&&this.mountPoint.setAttribute("data-theme",e.theme);if(this.config.apiBaseUrl!==r.apiBaseUrl||this.config.pageSize!==r.pageSize||this.config.postSlug!==r.postSlug){const e=t(this.config);this.api=e,this.unsubscribe&&this.unsubscribe(),this.store=l(this.config,e.fetchComments.bind(e),e.submitComment.bind(e)),this.unsubscribe=this.store.store.subscribe(e=>{this._onStateChange(e)}),this.store.loadComments()}}getConfig(){return{...this.config}}}function y(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function x(e){if(!e)return!0;try{return new URL(e),!0}catch{return!1}}function v(e){return e&&0!==e.trim().length?e.length>1e3?{valid:!1,error:"评论内容不能超过 1000 字"}:{valid:!0}:{valid:!1,error:"请输入评论内容"}}"undefined"!=typeof window&&(window.CWDComments=b);const E=Object.freeze(Object.defineProperty({__proto__:null,isValidEmail:y,isValidUrl:x,validateCommentContent:v,validateCommentForm:function(e){const t={};e.name&&0!==e.name.trim().length?e.name.length>50&&(t.name="昵称不能超过 50 字"):t.name="请输入昵称",e.email&&0!==e.email.trim().length?y(e.email)||(t.email="邮箱格式不正确"):t.email="请输入邮箱",e.url&&!x(e.url)&&(t.url="网址格式不正确");const r=v(e.content);return r.valid||(t.content=r.error),{valid:0===Object.keys(t).length,errors:t}},validateReplyUserInfo:function(e){const t={};return e.name&&0!==e.name.trim().length?e.name.length>50&&(t.name="昵称不能超过 50 字"):t.name="请输入昵称",e.email&&0!==e.email.trim().length?y(e.email)||(t.email="邮箱格式不正确"):t.email="请输入邮箱",e.url&&!x(e.url)&&(t.url="网址格式不正确"),{valid:0===Object.keys(t).length,errors:t}}},Symbol.toStringTag,{value:"Module"}));e.CWDComments=b,e.default=b,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
